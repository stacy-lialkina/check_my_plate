<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calorie Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            color: #333;
            font-size: 2em;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .lang-switcher {
            display: flex;
            gap: 5px;
            background: #f0f0f0;
            border-radius: 8px;
            padding: 5px;
        }

        .lang-btn {
            padding: 8px 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 5px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .lang-btn.active {
            background: #667eea;
            color: white;
        }

        .glucose-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9ff;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .glucose-toggle.active {
            border-color: #667eea;
            background: #e8ebff;
        }

        .glucose-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .glucose-label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }

        .info-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: help;
            position: relative;
        }

        .info-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            margin-bottom: 5px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .info-icon:hover .info-tooltip {
            opacity: 1;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.01);
        }

        #fileInput {
            display: none;
        }

        .preview-container {
            margin: 20px 0;
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s ease;
            font-weight: bold;
        }

        .analyze-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error, .info-message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        .error {
            background: #fee;
            color: #c33;
        }

        .info-message {
            background: #e8f4fd;
            color: #0066cc;
        }

        .products-section {
            margin-top: 30px;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .products-table th,
        .products-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .products-table th {
            background: #f8f9ff;
            font-weight: 600;
            color: #333;
        }

        .products-table tr:hover {
            background: #f8f9ff;
        }

        .product-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .grams-input {
            width: 100px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            text-align: right;
        }

        .remove-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-btn:hover {
            background: #cc0000;
        }

        .add-product-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .add-product-btn:hover {
            background: #5568d3;
        }

        .total-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .total-section h2 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .total-section .subtotal {
            font-size: 1.1em;
            opacity: 0.9;
            margin-top: 10px;
        }

        .disclaimer {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 5px;
            font-size: 0.9em;
            color: #856404;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .modal-content p {
            margin-bottom: 15px;
            line-height: 1.6;
            color: #666;
        }

        .modal-content .warning {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }

        .modal-close-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
        }

        .modal-close-btn:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 data-i18n="title">–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∫–∞–ª–æ—Ä–∏–π</h1>
            <div class="controls">
                <div class="lang-switcher">
                    <button class="lang-btn active" data-lang="ru">RU</button>
                    <button class="lang-btn" data-lang="uk">UA</button>
                    <button class="lang-btn" data-lang="en">EN</button>
                </div>
                <div class="glucose-toggle" id="glucoseToggle">
                    <input type="checkbox" id="glucoseCheckbox">
                    <label class="glucose-label" for="glucoseCheckbox">
                        <span>Glucose Balance+</span>
                        <span class="info-icon">
                            ‚ÑπÔ∏è
                            <span class="info-tooltip" id="glucoseTooltip"></span>
                        </span>
                    </label>
                </div>
            </div>
        </div>

        <div class="upload-section">
        <div class="upload-area" id="uploadArea">
                <div style="font-size: 48px; margin-bottom: 15px;">üì∏</div>
                <div data-i18n="upload_text" style="color: #667eea; font-size: 1.2em; margin-bottom: 10px;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ</div>
                <div data-i18n="upload_hint" style="color: #999; font-size: 0.9em;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, PNG, GIF (–º–∞–∫—Å. 16MB)</div>
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <div class="preview-container" id="previewContainer" style="display: none;">
            <img id="previewImage" class="preview-image" alt="Preview">
        </div>

            <div style="text-align: center;">
                <button class="analyze-btn" id="analyzeBtn" disabled data-i18n="analyze_btn">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ</button>
            </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
                <p data-i18n="analyzing">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à—É —Ç–∞—Ä–µ–ª–∫—É...</p>
        </div>

        <div class="error" id="error"></div>
            <div class="info-message" id="infoMessage"></div>
        </div>

        <div class="products-section" id="productsSection" style="display: none;">
            <button class="add-product-btn" id="addProductBtn" data-i18n="add_product">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</button>
            <table class="products-table">
                <thead>
                    <tr>
                        <th data-i18n="col_product">–ü—Ä–æ–¥—É–∫—Ç</th>
                        <th data-i18n="col_grams">–ì—Ä–∞–º–º—ã</th>
                        <th data-i18n="col_kcal">–∫–∫–∞–ª</th>
                        <th class="glucose-col" data-i18n="col_carbs" style="display: none;">–£–≥–ª–µ–≤–æ–¥—ã (–≥)</th>
                        <th class="glucose-col" data-i18n="col_sugar" style="display: none;">–°–∞—Ö–∞—Ä–∞ (–≥)</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                </tbody>
            </table>

            <div class="total-section">
                <h2>
                    <span data-i18n="total">–ò—Ç–æ–≥–æ:</span>
                    <span id="totalKcal">0</span>
                    <span data-i18n="kcal_unit">–∫–∫–∞–ª</span>
                </h2>
                <div class="subtotal" id="glucoseSubtotal" style="display: none;">
                    <span data-i18n="total_carbs">–£–≥–ª–µ–≤–æ–¥—ã:</span>
                    <span id="totalCarbs">0</span>
                    <span data-i18n="grams_unit">–≥</span>
                    <span> ‚Ä¢ </span>
                    <span data-i18n="total_sugar">–°–∞—Ö–∞—Ä–∞:</span>
                    <span id="totalSugar">0</span>
                    <span data-i18n="grams_unit">–≥</span>
                </div>
            </div>

            <div class="disclaimer" data-i18n="disclaimer">
                ‚ö†Ô∏è –ó–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ, –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π.
            </div>
        </div>
    </div>

    <!-- Glucose Balance+ Modal -->
    <div class="modal" id="glucoseModal">
        <div class="modal-content">
            <h3 data-i18n="modal_title">Glucose Balance+</h3>
            <p data-i18n="modal_text1">–ú—ã –¥–æ–±–∞–≤–∏–º –∫ –∫–∞–ª–æ—Ä–∏—è–º –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –∏ —Å–∞—Ö–∞—Ä–∞ –≤ –µ–¥–µ.</p>
            <p data-i18n="modal_text2">–≠—Ç–æ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å, –µ—Å–ª–∏ —Ç—ã —Å–ª–µ–¥–∏—à—å –∑–∞ —É—Ä–æ–≤–Ω–µ–º –≥–ª—é–∫–æ–∑—ã –∏–ª–∏ —Ö–æ—á–µ—à—å –º–µ–Ω—å—à–µ —Ä–µ–∑–∫–∏—Ö —Å–∫–∞—á–∫–æ–≤ —Å–∞—Ö–∞—Ä–∞.</p>
            <div class="warning">
                <strong>‚ö†Ô∏è</strong> <span data-i18n="modal_warning">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤—Ä–∞—á–∞ –∏–ª–∏ —Ç–≤–æ–π –ø–ª–∞–Ω –ø—Ä–∏ –¥–∏–∞–±–µ—Ç–µ.</span>
            </div>
            <button class="modal-close-btn" id="modalCloseBtn" data-i18n="modal_gotit">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
    </div>

    <script>
        // Calorie database from backend
        const CALORIE_DB = {{ calorie_db|safe }};

        // Current state
        let currentLang = localStorage.getItem('lang') || 'ru';
        let glucoseMode = localStorage.getItem('glucoseMode') === 'true';
        let glucoseModalShown = localStorage.getItem('glucoseModalShown') === 'true';
        let products = [];
        let selectedFile = null;

        // Localization
        const I18N = {
            ru: {
                title: "–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∫–∞–ª–æ—Ä–∏–π",
                upload_text: "–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ",
                upload_hint: "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, PNG, GIF (–º–∞–∫—Å. 16MB)",
                analyze_btn: "–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ",
                analyzing: "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à—É —Ç–∞—Ä–µ–ª–∫—É...",
                col_product: "–ü—Ä–æ–¥—É–∫—Ç",
                col_grams: "–ì—Ä–∞–º–º—ã",
                col_kcal: "–∫–∫–∞–ª",
                col_carbs: "–£–≥–ª–µ–≤–æ–¥—ã (–≥)",
                col_sugar: "–°–∞—Ö–∞—Ä–∞ (–≥)",
                add_product: "+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç",
                total: "–ò—Ç–æ–≥–æ:",
                kcal_unit: "–∫–∫–∞–ª",
                grams_unit: "–≥",
                total_carbs: "–£–≥–ª–µ–≤–æ–¥—ã:",
                total_sugar: "–°–∞—Ö–∞—Ä–∞:",
                disclaimer: "‚ö†Ô∏è –ó–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ, –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π.",
                glucose_tooltip: "Glucose Balance+ –ø–æ–º–æ–≥–∞–µ—Ç –≤–∏–¥–µ—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ –∫–∞–ª–æ—Ä–∏–∏, –Ω–æ –∏ —É–≥–ª–µ–≤–æ–¥—ã –∏ —Å–∞—Ö–∞—Ä–∞ –≤ –ø—Ä–∏—ë–º–µ –ø–∏—â–∏.",
                glucose_label: "–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≥–ª–µ–≤–æ–¥—ã –∏ —Å–∞—Ö–∞—Ä–∞",
                modal_title: "Glucose Balance+",
                modal_text1: "–ú—ã –¥–æ–±–∞–≤–∏–º –∫ –∫–∞–ª–æ—Ä–∏—è–º –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –∏ —Å–∞—Ö–∞—Ä–∞ –≤ –µ–¥–µ.",
                modal_text2: "–≠—Ç–æ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å, –µ—Å–ª–∏ —Ç—ã —Å–ª–µ–¥–∏—à—å –∑–∞ —É—Ä–æ–≤–Ω–µ–º –≥–ª—é–∫–æ–∑—ã –∏–ª–∏ —Ö–æ—á–µ—à—å –º–µ–Ω—å—à–µ —Ä–µ–∑–∫–∏—Ö —Å–∫–∞—á–∫–æ–≤ —Å–∞—Ö–∞—Ä–∞.",
                modal_warning: "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤—Ä–∞—á–∞ –∏–ª–∏ —Ç–≤–æ–π –ø–ª–∞–Ω –ø—Ä–∏ –¥–∏–∞–±–µ—Ç–µ.",
                modal_gotit: "–ü–æ–Ω—è—Ç–Ω–æ",
                no_recognition: "–ù–µ —Å–º–æ–≥–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å, –≤—ã–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –≤—Ä—É—á–Ω—É—é",
                error_no_file: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",
                error_invalid_type: "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞"
            },
            uk: {
                title: "–ê–Ω–∞–ª—ñ–∑–∞—Ç–æ—Ä –∫–∞–ª–æ—Ä—ñ–π",
                upload_text: "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–±–æ –ø–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–æ—Ç–æ",
                upload_hint: "–ü—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è: JPG, PNG, GIF (–º–∞–∫—Å. 16MB)",
                analyze_btn: "–ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Ñ–æ—Ç–æ",
                analyzing: "–ê–Ω–∞–ª—ñ–∑—É—î–º–æ –≤–∞—à—É —Ç–∞—Ä—ñ–ª–∫—É...",
                col_product: "–ü—Ä–æ–¥—É–∫—Ç",
                col_grams: "–ì—Ä–∞–º–∏",
                col_kcal: "–∫–∫–∞–ª",
                col_carbs: "–í—É–≥–ª–µ–≤–æ–¥–∏ (–≥)",
                col_sugar: "–¶—É–∫—Ä–∏ (–≥)",
                add_product: "+ –î–æ–¥–∞—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç",
                total: "–†–∞–∑–æ–º:",
                kcal_unit: "–∫–∫–∞–ª",
                grams_unit: "–≥",
                total_carbs: "–í—É–≥–ª–µ–≤–æ–¥–∏:",
                total_sugar: "–¶—É–∫—Ä–∏:",
                disclaimer: "‚ö†Ô∏è –ó–Ω–∞—á–µ–Ω–Ω—è –Ω–∞–±–ª–∏–∂–µ–Ω—ñ, –Ω–µ —î –º–µ–¥–∏—á–Ω–æ—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—î—é.",
                glucose_tooltip: "Glucose Balance+ –ø–æ–∫–∞–∑—É—î –Ω–µ –ª–∏—à–µ –∫–∞–ª–æ—Ä—ñ—ó, –∞ –π –≤—É–≥–ª–µ–≤–æ–¥–∏ —Ç–∞ —Ü—É–∫—Ä–∏ –≤ –ø—Ä–∏–π–æ–º—ñ —ó–∂—ñ.",
                glucose_label: "–ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –≤—É–≥–ª–µ–≤–æ–¥–∏ —Ç–∞ —Ü—É–∫—Ä–∏",
                modal_title: "Glucose Balance+",
                modal_text1: "–ú–∏ –¥–æ–¥–∞–º–æ –¥–æ –∫–∞–ª–æ—Ä—ñ–π –Ω–∞–±–ª–∏–∂–µ–Ω—ñ –≤—É–≥–ª–µ–≤–æ–¥–∏ —Ç–∞ —Ü—É–∫—Ä–∏ –≤ —ó–∂—ñ.",
                modal_text2: "–¶–µ –º–æ–∂–µ –¥–æ–ø–æ–º–æ–≥—Ç–∏, —è–∫—â–æ —Ç–∏ —Å—Ç–µ–∂–∏—à –∑–∞ —Ä—ñ–≤–Ω–µ–º –≥–ª—é–∫–æ–∑–∏ –∞–±–æ —Ö–æ—á–µ—à –º–µ–Ω—à–µ —Ä—ñ–∑–∫–∏—Ö —Å—Ç—Ä–∏–±–∫—ñ–≤ —Ü—É–∫—Ä—É.",
                modal_warning: "–î–æ–¥–∞—Ç–æ–∫ –Ω–µ –∑–∞–º—ñ–Ω—é—î —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –ª—ñ–∫–∞—Ä—è –∞–±–æ —Ç–≤—ñ–π –ø–ª–∞–Ω –ø—Ä–∏ –¥—ñ–∞–±–µ—Ç—ñ.",
                modal_gotit: "–ó—Ä–æ–∑—É–º—ñ–ª–æ",
                no_recognition: "–ù–µ –∑–º–æ–≥–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏, –≤–∏–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ –≤—Ä—É—á–Ω—É",
                error_no_file: "–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è",
                error_invalid_type: "–ù–µ–ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–∏–π —Ç–∏–ø —Ñ–∞–π–ª—É"
            },
            en: {
                title: "Calorie Analyzer",
                upload_text: "Click to upload or drag & drop photo",
                upload_hint: "Supports: JPG, PNG, GIF (max 16MB)",
                analyze_btn: "Analyze Photo",
                analyzing: "Analyzing your plate...",
                col_product: "Product",
                col_grams: "Grams",
                col_kcal: "kcal",
                col_carbs: "Carbs (g)",
                col_sugar: "Sugar (g)",
                add_product: "+ Add Product",
                total: "Total:",
                kcal_unit: "kcal",
                grams_unit: "g",
                total_carbs: "Carbs:",
                total_sugar: "Sugar:",
                disclaimer: "‚ö†Ô∏è Values are approximate, not a medical recommendation.",
                glucose_tooltip: "Glucose Balance+ shows not just calories, but also carbs and sugars in your meal.",
                glucose_label: "show carbs & sugars",
                modal_title: "Glucose Balance+",
                modal_text1: "We'll add approximate carbs and sugars to calories.",
                modal_text2: "This can help if you're tracking glucose levels or want fewer sugar spikes.",
                modal_warning: "The app does not replace doctor's recommendations or your diabetes plan.",
                modal_gotit: "Got it",
                no_recognition: "Could not automatically recognize, please select products manually",
                error_no_file: "Please upload an image",
                error_invalid_type: "Unsupported file type"
            }
        };

        // Initialize
        function init() {
            setupLanguage();
            setupGlucoseMode();
            setupUpload();
            setupProducts();
        }

        // Language switching
        function setupLanguage() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentLang = btn.dataset.lang;
                    localStorage.setItem('lang', currentLang);
                    updateLanguage();
                });
            });
            updateLanguage();
        }

        function updateLanguage() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === currentLang);
            });

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (I18N[currentLang] && I18N[currentLang][key]) {
                    el.textContent = I18N[currentLang][key];
                }
            });

            // Update tooltip
            const tooltip = document.getElementById('glucoseTooltip');
            if (tooltip) {
                tooltip.textContent = I18N[currentLang].glucose_tooltip;
            }

            // Update product names in selects
            updateProductSelects();
            recalculateTotals();
        }

        // Glucose Balance+ mode
        function setupGlucoseMode() {
            const checkbox = document.getElementById('glucoseCheckbox');
            checkbox.checked = glucoseMode;
            updateGlucoseMode();

            checkbox.addEventListener('change', () => {
                glucoseMode = checkbox.checked;
                localStorage.setItem('glucoseMode', glucoseMode);
                
                if (glucoseMode && !glucoseModalShown) {
                    showGlucoseModal();
                }
                
                updateGlucoseMode();
            });
        }

        function updateGlucoseMode() {
            const toggle = document.getElementById('glucoseToggle');
            toggle.classList.toggle('active', glucoseMode);
            
            document.querySelectorAll('.glucose-col').forEach(col => {
                col.style.display = glucoseMode ? '' : 'none';
            });
            
            const subtotal = document.getElementById('glucoseSubtotal');
            if (subtotal) {
                subtotal.style.display = glucoseMode ? '' : 'none';
            }
            
            recalculateTotals();
        }

        function showGlucoseModal() {
            const modal = document.getElementById('glucoseModal');
            modal.classList.add('active');
            glucoseModalShown = true;
            localStorage.setItem('glucoseModalShown', 'true');
        }

        document.getElementById('modalCloseBtn').addEventListener('click', () => {
            document.getElementById('glucoseModal').classList.remove('active');
        });

        // File upload
        function setupUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const analyzeBtn = document.getElementById('analyzeBtn');

        uploadArea.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

            analyzeBtn.addEventListener('click', analyzeImage);
        }

        function handleFile(file) {
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showError(I18N[currentLang].error_invalid_type);
                return;
            }

            selectedFile = file;
            const reader = new FileReader();

            reader.onload = (e) => {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('previewContainer').style.display = 'block';
                document.getElementById('analyzeBtn').disabled = false;
                hideError();
                hideInfo();
            };

            reader.readAsDataURL(file);
        }

        async function analyzeImage() {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);

            const analyzeBtn = document.getElementById('analyzeBtn');
            const loading = document.getElementById('loading');
            const productsSection = document.getElementById('productsSection');

            analyzeBtn.disabled = true;
            loading.style.display = 'block';
            hideError();
            hideInfo();

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Analysis failed');
                }

                // Add detected items to products
                if (data.detected_items && data.detected_items.length > 0) {
                    data.detected_items.forEach(item => {
                        const grams = item.estimated_grams || 100; // Use estimated grams from API or default to 100g
                        addProduct(item.key, grams);
                    });
                } else {
                    showInfo(I18N[currentLang].no_recognition);
                    // Add one empty product row
                    addProduct('', 100);
                }

                productsSection.style.display = 'block';
            } catch (err) {
                showError(err.message);
            } finally {
                analyzeBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // Products management
        function setupProducts() {
            document.getElementById('addProductBtn').addEventListener('click', () => {
                addProduct('', 100);
            });
        }

        function addProduct(key = '', grams = 100) {
            const productId = Date.now() + Math.random();
            products.push({ id: productId, key, grams });
            
            const tbody = document.getElementById('productsTableBody');
            const row = document.createElement('tr');
            row.id = `product-${productId}`;
            
            const nameKey = `name_${currentLang}`;
            const productOptions = Object.keys(CALORIE_DB).map(k => {
                const item = CALORIE_DB[k];
                const name = item[nameKey] || item.name_en || k;
                return `<option value="${k}" ${k === key ? 'selected' : ''}>${name}</option>`;
            }).join('');
            
            row.innerHTML = `
                <td>
                    <select class="product-select" data-product-id="${productId}">
                        <option value="">-- ${I18N[currentLang].col_product} --</option>
                        ${productOptions}
                    </select>
                </td>
                <td>
                    <input type="number" class="grams-input" value="${grams}" min="0" step="1" data-product-id="${productId}">
                </td>
                <td class="kcal-cell" data-product-id="${productId}">0</td>
                <td class="glucose-col carbs-cell" data-product-id="${productId}" style="display: ${glucoseMode ? '' : 'none'}">0</td>
                <td class="glucose-col sugar-cell" data-product-id="${productId}" style="display: ${glucoseMode ? '' : 'none'}">0</td>
                <td>
                    <button class="remove-btn" onclick="removeProduct(${productId})">√ó</button>
                </td>
            `;
            
            tbody.appendChild(row);
            
            // Add event listeners
            row.querySelector('.product-select').addEventListener('change', (e) => {
                const product = products.find(p => p.id === productId);
                if (product) {
                    product.key = e.target.value;
                    recalculateProduct(productId);
                }
            });
            
            row.querySelector('.grams-input').addEventListener('input', (e) => {
                const product = products.find(p => p.id === productId);
                if (product) {
                    product.grams = parseFloat(e.target.value) || 0;
                    recalculateProduct(productId);
                }
            });
            
            recalculateProduct(productId);
            document.getElementById('productsSection').style.display = 'block';
        }

        function removeProduct(id) {
            products = products.filter(p => p.id !== id);
            const row = document.getElementById(`product-${id}`);
            if (row) {
                row.remove();
            }
            recalculateTotals();
            
            if (products.length === 0) {
                document.getElementById('productsSection').style.display = 'none';
            }
        }

        function updateProductSelects() {
            products.forEach(product => {
                const select = document.querySelector(`select[data-product-id="${product.id}"]`);
                if (select) {
                    const nameKey = `name_${currentLang}`;
                    Array.from(select.options).forEach(option => {
                        if (option.value && CALORIE_DB[option.value]) {
                            const item = CALORIE_DB[option.value];
                            option.textContent = item[nameKey] || item.name_en || option.value;
                        }
                    });
                }
            });
        }

        function recalculateProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product || !product.key || !CALORIE_DB[product.key]) {
                document.querySelector(`.kcal-cell[data-product-id="${id}"]`).textContent = '0';
                document.querySelector(`.carbs-cell[data-product-id="${id}"]`).textContent = '0';
                document.querySelector(`.sugar-cell[data-product-id="${id}"]`).textContent = '0';
                return;
            }

            const item = CALORIE_DB[product.key];
            const grams = product.grams || 0;
            
            const kcal = (item.kcal * grams) / 100;
            const carbs = (item.carbs * grams) / 100;
            const sugar = (item.sugar * grams) / 100;
            
            document.querySelector(`.kcal-cell[data-product-id="${id}"]`).textContent = Math.round(kcal);
            document.querySelector(`.carbs-cell[data-product-id="${id}"]`).textContent = Math.round(carbs);
            document.querySelector(`.sugar-cell[data-product-id="${id}"]`).textContent = Math.round(sugar);
            
            recalculateTotals();
        }

        function recalculateTotals() {
            let totalKcal = 0;
            let totalCarbs = 0;
            let totalSugar = 0;
            
            products.forEach(product => {
                if (product.key && CALORIE_DB[product.key]) {
                    const item = CALORIE_DB[product.key];
                    const grams = product.grams || 0;
                    totalKcal += (item.kcal * grams) / 100;
                    totalCarbs += (item.carbs * grams) / 100;
                    totalSugar += (item.sugar * grams) / 100;
                }
            });
            
            document.getElementById('totalKcal').textContent = Math.round(totalKcal);
            document.getElementById('totalCarbs').textContent = Math.round(totalCarbs);
            document.getElementById('totalSugar').textContent = Math.round(totalSugar);
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showInfo(message) {
            const info = document.getElementById('infoMessage');
            info.textContent = message;
            info.style.display = 'block';
        }

        function hideInfo() {
            document.getElementById('infoMessage').style.display = 'none';
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
